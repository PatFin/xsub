#!/usr/bin/env ruby

root = File.expand_path('../../', __FILE__)
$:.unshift File.expand_path('lib', root)

require 'any_scheduler'
require 'optparse'
require 'json'
require 'logger'
require 'fileutils'

Version = AnyScheduler::VERSION
scheduler = AnyScheduler.load_scheduler
parameters = {}
logger = Logger.new(STDERR)
LOG_ROTATE_SIZE = 7
work_dir = '.'

OptionParser.new { |parser|
  parser.on('-t', '--show-template', 'show template') do |t|
    raise "scheduler type is not given" unless scheduler
    h = {parameters: scheduler.parameter_definitions, template: scheduler.template }
    $stdout.print JSON.pretty_generate(h)
    exit
  end

  parser.on('-p', '--parameters [PARAM]', 'parameters') do |param|
    parameters = JSON.load(param.sub(/^=/,'')) if param.size > 0
  end

  parser.on('-d', '--dir [WORKDIR]', 'work directory') do |dir|
    if dir.size > 0
      work_dir = dir.sub(/^=/, '')
      FileUtils.mkdir_p(work_dir)
      logfile = File.join(work_dir, "submission_log.txt")
      logger = Logger.new(logfile , LOG_ROTATE_SIZE)
    end
  end

}.parse!(ARGV)

raise "scheduler type is not given" unless scheduler
raise "you should give one argument" unless ARGV.size == 1
output = scheduler.submit(ARGV[0], parameters, logger: logger, work_dir: work_dir)
$stdout.print JSON.pretty_generate(output)
